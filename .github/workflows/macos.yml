name: macOS VNC with GUI

on: workflow_dispatch

jobs:
  vnc-setup:
    runs-on: macos-latest
    
    steps:
      - name: Setup VNC with GUI Session
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          set -e
          
          echo "üîß System preparation..."
          sudo mdutil -i off -a
          
          echo "üë§ Creating VNC user..."
          USERNAME="vncuser"
          PASSWORD="P@ssw0rd!"
          
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "VNC User"
          sudo dscl . -create /Users/$USERNAME UniqueID 502
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"
          sudo dscl . -append /Groups/admin GroupMembership $USERNAME
          sudo createhomedir -c -u $USERNAME 2>/dev/null || true
          
          echo "üñ•Ô∏è Creating GUI session (CRITICAL STEP)..."
          # Enable auto-login to create active GUI session
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser "$USERNAME"
          
          # Start LoginWindow session - questo √® il trucco!
          sudo launchctl bootstrap gui/502 /System/Library/LaunchAgents/com.apple.loginwindow.plist 2>/dev/null || true
          
          # Trigger GUI session creation
          sudo /System/Library/CoreServices/Menu Extras/User.menu/Contents/Resources/CGSession -switchToUserID 502 2>/dev/null || true
          
          sleep 5
          
          echo "üîì Configuring TCC permissions..."
          # Add permissions to BOTH system and user TCC databases
          for DB in "/Library/Application Support/com.apple.TCC/TCC.db" "/Users/$USERNAME/Library/Application Support/com.apple.TCC/TCC.db"; do
            if [ -f "$DB" ]; then
              sudo sqlite3 "$DB" "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.screensharing',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
              sudo sqlite3 "$DB" "INSERT OR REPLACE INTO access VALUES('kTCCServiceListenEvent','com.apple.screensharing',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
              sudo sqlite3 "$DB" "INSERT OR REPLACE INTO access VALUES('kTCCServicePostEvent','com.apple.screensharing',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
              sudo sqlite3 "$DB" "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.screensharing',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
            fi
          done
          
          sudo killall -9 tccd 2>/dev/null || true
          sleep 3
          
          echo "üñ•Ô∏è Enabling built-in Screen Sharing..."
          # Method from vnc-tools/debug-on-mac
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -users $USERNAME \
            -privs -all \
            -restart
          
          # Set VNC password using the perl method (funziona per il built-in VNC)
          echo "$PASSWORD" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "
"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          
          # Enable legacy VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure \
            -clientopts -setvnclegacy -vnclegacy yes
          
          # Final restart with console
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent -console
          
          echo "‚è≥ Waiting for services..."
          sleep 10
          
          # Check VNC port
          if lsof -iTCP:5900 -sTCP:LISTEN > /dev/null 2>&1; then
            echo "‚úÖ VNC server is running"
          else
            echo "‚ö†Ô∏è VNC may not be ready yet"
          fi
          
          # Check if GUI session exists
          if ps aux | grep -v grep | grep loginwindow > /dev/null; then
            echo "‚úÖ GUI session is active"
          else
            echo "‚ö†Ô∏è GUI session may not be active"
          fi
          
          echo "üì¶ Setting up ngrok..."
          brew install --cask ngrok
          ngrok config add-authtoken "$NGROK_TOKEN"
          ngrok tcp 5900 --region=us > /tmp/ngrok.log 2>&1 &
          
          sleep 6
          
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'tcp://[^"]*' | head -1 || echo "")
          
          if [ -z "$NGROK_URL" ]; then
            NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['tunnels'][0]['public_url'] if data.get('tunnels') else 'Check localhost:4040')" 2>/dev/null || echo "Check localhost:4040")
          fi
          
          echo ""
          echo "================================================"
          echo "‚úÖ macOS VNC Desktop Ready!"
          echo "================================================"
          echo "VNC Address: ${NGROK_URL}"
          echo "Username: $USERNAME"
          echo "Password: $PASSWORD"
          echo "================================================"
          echo ""
          echo "Clients to use:"
          echo "  ‚Ä¢ Apple Screen Sharing (best)"
          echo "  ‚Ä¢ RealVNC Viewer"
          echo "  ‚Ä¢ TigerVNC"
          echo ""
          echo "üîÑ Keeping session alive for 6 hours..."
          echo ""
          
          # Keep the session alive
          sleep 21600
